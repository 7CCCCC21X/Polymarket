<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>Polymarket æ•°æ®æ‰¹é‡æŸ¥è¯¢</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
/* ========= å…¨å±€è‰²æ¿ ========= */
:root{
  --c-primary:#0078d7;--c-primary-dark:#005fa3;
  --c-bg:#fafafa;--c-card:#fff;--c-border:#e5e7eb;
  --c-text:#222;--c-sub:#555;--c-green:#16a34a;--c-red:#e11d48;
}
*{box-sizing:border-box;margin:0;padding:0}

/* ========= åŸºç¡€æ’ç‰ˆ ========= */
body{
  font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;
  background:var(--c-bg);color:var(--c-text);line-height:1.6;padding:24px;
}
h1{text-align:center;font-size:28px;margin-bottom:24px;color:var(--c-primary)}
h2{
  text-align:center;font-size:22px;margin:40px 0 12px;color:var(--c-primary);position:relative
}
h2::after{
  content:'';display:block;width:80px;height:2px;background:var(--c-primary);
  margin:8px auto 0;border-radius:1px
}
.desc{max-width:780px;margin:0 auto 20px;text-align:center;font-size:14px;color:var(--c-sub)}

/* ========= æé†’ ========= */
.note{
  text-align:center;font-size:14px;font-weight:600;
  color:var(--c-red);margin:4px 0 12px;
}

/* ========= å¡ç‰‡ ========= */
.card{
  max-width:1000px;margin:0 auto 24px;background:var(--c-card);
  border:1px solid var(--c-border);border-radius:8px;
  box-shadow:0 4px 10px rgba(0,0,0,.05);padding:24px
}

/* ========= è¡¨å• & æŒ‰é’® ========= */
textarea{
  width:100%;min-height:120px;resize:vertical;padding:10px;
  border:1px solid var(--c-border);border-radius:6px
}
button{
  padding:10px 18px;font-size:15px;border:none;border-radius:6px;
  background:var(--c-primary);color:#fff;margin:8px;cursor:pointer;transition:.2s
}
button:hover:not(:disabled){background:var(--c-primary-dark);transform:translateY(-2px)}
button:disabled{background:#9ca3af}
.center{text-align:center}

/* ========= è¿›åº¦æ¡ ========= */
#loading{margin-top:12px;text-align:center;color:var(--c-primary)}
progress{
  width:100%;height:8px;border:none;border-radius:4px;background:var(--c-border)
}
progress::-webkit-progress-value{background:var(--c-primary)}

/* ========= æè¦æ¡† ========= */
#summary{
  display:none;margin:18px 0 12px;padding:10px 12px;background:#e8f1ff;
  border-left:4px solid var(--c-primary);border-radius:4px;color:var(--c-primary);font-size:14px
}

/* ========= è¡¨æ ¼ ========= */
.table-wrap{overflow-x:auto}
table{width:100%;min-width:950px;border-collapse:collapse;background:var(--c-card)}
th,td{padding:14px 10px;border-bottom:1px solid var(--c-border);font-size:14px}
th{
  background:var(--c-primary);color:#fff;text-align:center;
  position:sticky;top:0;z-index:2
}
tbody tr:nth-child(even){background:#f7fafd}
td.number{text-align:right}

/* â€”â€”â˜…  ç²˜ä½åˆ—åˆ†å±‚ï¼šthead / tbody â˜…â€”â€” */
thead th:nth-child(1){position:sticky;left:0;background:var(--c-primary);z-index:3}
thead th:nth-child(2){position:sticky;left:46px;background:var(--c-primary);z-index:3}
tbody td:nth-child(1){position:sticky;left:0;background:var(--c-card);z-index:1}
tbody td:nth-child(2){position:sticky;left:46px;background:var(--c-card);z-index:1}

/* ========= é¢œè‰²æç¤º ========= */
.positive{color:var(--c-green)}
.negative{color:var(--c-red)}
.inactive{color:var(--c-red)}

/* ========= å¤åˆ¶æŒ‰é’® & Toast ========= */
.copy{margin-left:4px;font-size:14px;color:var(--c-sub);cursor:pointer}
.copy:hover{color:var(--c-primary)}
.toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:#333;color:#fff;padding:6px 12px;border-radius:4px;
  font-size:14px;opacity:0;transition:.3s
}

/* ========= é¡µè„š ========= */
.footer{text-align:center;font-size:14px;color:var(--c-sub);margin-top:40px}
.footer a{color:var(--c-primary);text-decoration:none}
</style>
</head>

<body>
<h1>Polymarket æ•°æ®æ‰¹é‡æŸ¥è¯¢</h1>
<h2>æ‰¹é‡æŸ¥è¯¢åœ°å€æ•°æ®</h2>
<p class="desc">ç²˜è´´åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼Œç³»ç»ŸæŒ‰é¡ºåºé€ä¸ªæŸ¥è¯¢å¹¶å®æ—¶æ›´æ–°ç»“æœã€‚</p>

<div class="card">
  <textarea id="input" placeholder=""></textarea>

  <!-- æŸ¥è¯¢å‰æé†’ -->
  <p class="note">æç¤ºï¼šæŸ¥è¯¢å‰è¯·å°† VPN åˆ‡æ¢åˆ°ã€Œå…¨å±€æ¨¡å¼ã€</p>

  <div class="center" style="margin-top:6px;">
    <button id="run">æŸ¥è¯¢</button>
    <button id="csv" disabled>å¯¼å‡º CSV</button>
  </div>

  <div id="loading" style="display:none;">
    <progress id="bar" value="0" max="100"></progress>
    <div id="barTxt"></div>
  </div>

  <div id="summary"></div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th><th>åœ°å€ï¼ˆSafeï¼‰</th>
          <th class="number">äº¤æ˜“é¢</th><th class="number">æ± å­æ•°</th>
          <th class="number">ç›ˆäº</th><th class="number">å¯ç”¨</th>
          <th class="number">æŒä»“</th><th class="number">æ€»ä½™é¢</th>
          <th class="number">æ—¥æ´»</th><th class="number">æœˆæ´»</th><th>æœ€åæ´»è·ƒ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<p class="footer">Â© 2025 Polymarket Toolbox ï½œ <a href="https://x.com/0xXIAOc" target="_blank">0xXIAOc</a></p>
<div id="toast" class="toast"></div>

<script>
/* ========= å·¥å…· ========= */
const $=s=>document.querySelector(s);
const fmtInt=n=>isNaN(+n)?'-':Math.round(+n).toLocaleString('en-US');
const fmtDec=n=>isNaN(+n)?'-':(+n).toLocaleString('en-US',{minimumFractionDigits:(+n%1?2:0)});
const clip=a=>a.length>12?`${a.slice(0,6)}â€¦${a.slice(-4)}`:a;
function toast(t){const el=$("#toast");el.textContent=t;el.style.opacity=1;setTimeout(()=>el.style.opacity=0,1500);}
function copy(addr){navigator.clipboard.writeText(addr).then(()=>toast('å·²å¤åˆ¶'));}

/* ========= fetch with timeout ========= */
const TIMEOUT=5000;
function fetchT(url,opts={},timeout=TIMEOUT){
  const c=new AbortController(),tid=setTimeout(()=>c.abort(),timeout);
  return fetch(url,{...opts,signal:c.signal}).finally(()=>clearTimeout(tid));
}
async function fetchJ(url,opts={},tries=2){
  for(let i=0;i<tries;i++){
    try{
      const r=await fetchT(url,opts);
      if(!r.ok)throw new Error(r.status);
      return await r.json();
    }catch(e){
      if(i===tries-1)throw e;
      await new Promise(res=>setTimeout(res,800*(i+1)));
    }
  }
}

/* ========= USDC ä½™é¢ ========= */
async function getUSDC(addr){
  const data='0x70a08231000000000000000000000000'+addr.slice(2);
  const payload=()=>({
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify([{jsonrpc:'2.0',method:'eth_call',
      params:[{to:'0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',data},'latest'],id:1}])
  });
  try{
    const res=await Promise.any([
      fetchT('https://polygon-rpc.com',payload(),4000),
      fetchT('https://rpc.ankr.com/polygon',payload(),4000)
    ]);
    const j=await res.json();
    if(j[0]?.result)return (parseInt(j[0].result,16)/1e6).toFixed(2);
  }catch{}
  return '-';
}

/* ========= Polymarket API ========= */
const api={
  volume:a=>fetchJ(`https://lb-api.polymarket.com/volume?window=all&limit=1&address=${a}`)
            .then(d=>d[0]?.amount??'-'),
  traded:a=>fetchJ(`https://data-api.polymarket.com/traded?user=${a}`)
            .then(d=>d.traded??'-'),
  profit:a=>fetchJ(`https://lb-api.polymarket.com/profit?window=all&limit=1&address=${a}`)
            .then(d=>d[0]?.amount??'-'),
  usdc:getUSDC,
  value:a=>fetchJ(`https://data-api.polymarket.com/value?user=${a}`)
            .then(d=>d[0]?.value??'-'),
  activity:async a=>{
    try{
      const d=await fetchJ(`https://data-api.polymarket.com/activity?user=${a}&limit=999&offset=0`);
      if(!d.length)return{d:0,m:0,last:'-',thisMonth:false};
      d.sort((x,y)=>y.timestamp-x.timestamp);
      const ds=new Set,ms=new Set;
      d.forEach(i=>{
        const t=new Date(i.timestamp*1e3);
        ds.add(t.toISOString().split('T')[0]);
        ms.add(t.toISOString().slice(0,7));
      });
      const latest=new Date(d[0].timestamp*1e3),now=new Date();
      const thisMonth=latest.getFullYear()===now.getFullYear()&&latest.getMonth()===now.getMonth();
      const gap=Math.floor((Date.now()-latest)/864e5);
      return{d:ds.size,m:ms.size,last:gap?`${gap}å¤©å‰`:'ä»Šå¤©',thisMonth};
    }catch{return{d:0,m:0,last:'-',thisMonth:false};}
  }
};

/* ========= å•åœ°å€ï¼šSafe ç»´åº¦ ========= */
async function queryOne(ownerAddr){
  let safes=[];
  try{
    const res=await fetchJ(`https://safe-client.safe.global/v1/owners/${ownerAddr}/safes`).catch(()=>({137:[]}));
    safes=(res['137']||[]).slice(0,5);
  }catch{}

  if(!safes.length)return[{addr:ownerAddr,err:'æ— æ•°æ®'}];

  const rows=[];
  for(const safe of safes){
    try{
      const [vol,cnt,pro,hold,act,avail]=await Promise.all([
        api.volume(safe),api.traded(safe),api.profit(safe),
        api.value(safe),api.activity(safe),api.usdc(safe)   // Safe ä½™é¢
      ]);
      rows.push({addr:safe,vol,cnt,pro,avail,hold,act});
    }catch{rows.push({addr:safe,err:'å­æŸ¥è¯¢å¤±è´¥'});}
  }
  return rows;
}

/* ========= ä¸»æµç¨‹ ========= */
$("#run").onclick=async()=>{
  const list=$("#input").value.trim().split('\n').map(s=>s.trim()).filter(Boolean);
  if(!list.length)return toast('è¯·è¾“å…¥åœ°å€');

  const tbody=$("#tbl tbody");
  tbody.innerHTML='';
  $("#summary").style.display='none';
  $("#loading").style.display='block';
  $("#bar").value=0;$("#barTxt").textContent='';
  $("#run").disabled=$("#csv").disabled=true;

  let idx=1,fail=0;
  for(let i=0;i<list.length;i++){
    const addr=list[i];
    $("#bar").value=(i/list.length)*100;
    $("#barTxt").textContent=`${i}/${list.length}`;

    for(const row of await queryOne(addr)){
      row.err?appendErr(row.err,row.addr)
             :renderRow(row.addr,row.vol,row.cnt,row.pro,row.avail,row.hold,row.act);
    }

    $("#bar").value=((i+1)/list.length)*100;
    $("#barTxt").textContent=`${i+1}/${list.length}`;
  }

  $("#loading").style.display='none';
  $("#run").disabled=$("#csv").disabled=false;
  $("#summary").textContent=`å…±æŸ¥è¯¢ ${list.length} ä¸ªè¾“å…¥åœ°å€ï¼Œç”Ÿæˆ ${idx-1} è¡Œæ•°æ®ï¼Œå¤±è´¥ ${fail}`;
  $("#summary").style.display='block';

  /* â€”â€” æ¸²æŸ“ â€”â€” */
  function renderRow(a,vol,cnt,pro,avail,hold,act){
    const pNum=+pro;
    const sign=pNum<0?'â–¼':'â–²',cls=pNum<0?'negative':'positive';
    const total=(+avail + +hold).toFixed(2);
    const lastCls=act.thisMonth?'':'inactive';

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx}</td>
      <td>${clip(a)}<span class="copy" onclick="copy('${a}')">ğŸ“‹</span></td>
      <td class="number">${fmtInt(vol)}</td>
      <td class="number">${cnt}</td>
      <td class="number ${cls}">${sign} ${fmtInt(Math.abs(pNum))}</td>
      <td class="number">${fmtDec(avail)}</td>
      <td class="number">${fmtDec(hold)}</td>
      <td class="number">${fmtDec(total)}</td>
      <td class="number">${act.d}</td>
      <td class="number">${act.m}</td>
      <td class="${lastCls}">${act.last}</td>`;
    tbody.appendChild(tr);idx++;
    [...tbody.rows].forEach((r,i)=>r.style.background=i%2?'#f7fafd':'');
  }
  function appendErr(msg,badAddr){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx}</td><td>${clip(badAddr)}</td><td colspan="9" class="negative">${msg}</td>`;
    tbody.appendChild(tr);idx++;fail++;
  }
};

/* ========= å¯¼å‡º CSV ========= */
$("#csv").onclick=()=>{
  const rows=[...document.querySelectorAll('#tbl tr')].map(r=>[...r.children].map(td=>td.textContent.trim()));
  if(rows.length<=1)return toast('æš‚æ— æ•°æ®');
  const blob=new Blob(['\uFEFF'+rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download=`polymarket_${Date.now()}.csv`;a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
